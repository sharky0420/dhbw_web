<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DHBW Bank – Zwei-Faktor-Bestätigung</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      body {
        min-height: 100vh;
        background: radial-gradient(circle at top, #112b45, #0a1b2f 70%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Inter", system-ui, sans-serif;
      }

      .card-auth {
        max-width: 420px;
        width: 100%;
        border-radius: 20px;
        box-shadow: 0 28px 60px rgba(6, 24, 44, 0.45);
      }

      .code-display {
        font-family: "SFMono-Regular", "Menlo", "Monaco", monospace;
        font-size: 2.2rem;
        letter-spacing: 0.4rem;
        padding: 14px 0;
      }
    </style>
  </head>
  <body>
    <div class="card card-auth">
      <div class="card-header text-center bg-primary text-white">
        <h1 class="h4 mb-0">Zwei-Faktor-Bestätigung</h1>
      </div>
      <div class="card-body p-4">
        <p>
          Geben Sie den Code aus Ihrer Authenticator-App ein. Für Demo-Zwecke finden Sie den
          generierten Code unten.
        </p>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }}" role="alert">
          {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% if demo_code %}
        <div class="text-center mb-4">
          <span class="text-muted small text-uppercase">Demo Authenticator Code</span>
          <div class="code-display fw-bold">{{ demo_code }}</div>
        </div>
        {% endif %}

        <form action="{{ url_for('two_factor') }}" method="post" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="code" class="form-label">Bestätigungscode</label>
            <input
              type="text"
              id="code"
              name="code"
              class="form-control form-control-lg text-center"
              pattern="[0-9]{6}"
              maxlength="6"
              inputmode="numeric"
              autocomplete="one-time-code"
              placeholder="••••••"
              required
            />

            <div class="invalid-feedback">Bitte geben Sie den 6-stelligen Code ein.</div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg">Bestätigen &amp; fortfahren</button>
          </div>
        </form>
        <div class="mt-4 text-center">
          <a href="{{ url_for('login') }}" class="text-decoration-none">Zurück zum Login</a>
        </div>
      </div>
    </div>
    <script>
      (() => {
        "use strict";
        const forms = document.querySelectorAll(".needs-validation");
        const codeInput = document.getElementById("code");

        if (codeInput) {
          codeInput.addEventListener("input", () => {
            codeInput.value = codeInput.value.replace(/\D+/g, "").slice(0, 6);
          });
        }

        Array.from(forms).forEach((form) => {
          form.addEventListener("submit", (event) => {
            // Trim vor der Validierung
            if (codeInput) codeInput.value = codeInput.value.trim();
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add("was-validated");
          }, false);
        });
      })();
    </script>
  </body>
</html>
